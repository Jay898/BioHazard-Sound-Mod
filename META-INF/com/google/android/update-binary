#!/sbin/sh

# Made by anandmore for BioHazard Sound Mod @xda-developers.com
# This file contains parts from the scripts taken from the V4A 2.5.0.5 by guitardedhero
# This file contains parts from the update-binary taken from the SuperSU installation zip.
#
# This script is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# These scripts are distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

OUTFD=/proc/self/fd/$2;
ZIPFILE="$3";
DIR=$(dirname "$ZIPFILE");
ZIP=$3
BIOHAZARD=/tmp/zip
API=$(cat /system/build.prop | grep "ro.build.version.sdk=" | dd bs=1 skip=21 count=2)
ANGL=$(cat /system/build.prop | grep "ro.product.name=angler")
BULL=$(cat /system/build.prop | grep "ro.product.name=bullhead")
FLOU=$(cat /system/build.prop | grep "ro.product.name=flounder")
X86=$(cat /system/build.prop | grep "ro.product.cpu.abi=x86")
X8664=$(cat /system/build.prop | grep "ro.product.cpu.abi=x86_64")

ui_print() { echo -e "ui_print $1\nui_print" > $OUTFD; }

set_perm_recursive() {
  uid=$1; gid=$2; dmod=$3; fmod=$4;
  shift 4;
  until [ ! "$1" ]; do
    chown -R $uid.$gid $1; chown -R $uid:$gid $1;
    find "$1" -type d -exec chmod $dmod {} +;
    find "$1" -type f -exec chmod $fmod {} +;
    shift;
  done;
}

ui_print " "
ui_print " "
ui_print " "
ui_print " "
ui_print " "
ui_print "  _     _       _                            _ "
ui_print " | |__ (_) ___ | |__   __ _ ______ _ _ __ __| |"
ui_print " |  _ \| |/ _ \|  _ \ / _  |_  / _  |  __/ _  |"
ui_print " | |_) | | (_) | | | | (_| |/ / (_| | | | (_| |"
ui_print " |____/|_|\___/|_| |_|\__ _/___\__ _|_|  \__ _|"
ui_print " "
ui_print "                                   by anandmore"
ui_print " "
ui_print " "
ui_print " "
ui_print " "
ui_print " "

# Mount /system, /data and /vendor as r/w
mount /data
mount /system
if [ "$ANGL" ] || [ "$BULL" ] || [ "$FLOU" ]; then
  mount /vendor
fi

# Remove deep_buffer and raw from audio_policy.conf
if [ -f "/system/etc/audio_policy.conf" ]; then
  sed -i '/deep_buffer {/,/}/d' /system/etc/audio_policy.conf
  sed -i '/raw {/,/}/d' /system/etc/audio_policy.conf
fi
if [ -f "/system/vendor/etc/audio_policy.conf" ]; then
  sed -i '/deep_buffer {/,/}/d' /system/vendor/etc/audio_policy.conf
  sed -i '/raw {/,/}/d' /system/vendor/etc/audio_policy.conf
fi
if [ -f "/vendor/etc/audio_policy.conf" ]; then
  sed -i '/deep_buffer {/,/}/d' /vendor/etc/audio_policy.conf
  sed -i '/raw {/,/}/d' /vendor/etc/audio_policy.conf
fi

# Remove conflicting files and V4A installs
rm -rf /system/priv-app/ViPER4Android
rm -rf /system/priv-app/ViPER4Android_FX_A4.x
rm -rf /system/app/ViPER4Android_FX_A4.x
rm -rf /system/priv-app/Viper4Android
rm -rf /system/app/ViPER4Android
rm -rf /data/app/com.vipercn.viper4android-1
rm -rf /data/app/com.vipercn.viper4android-2
rm -rf /system/priv-app/ViPER4Arise
rm -rf /system/app/ViPER4Arise
rm -rf /system/priv-app/ViPER4ARISE
rm -rf /system/app/ViPER4ARISE
rm -rf /system/priv-app/AudioFX
rm -rf /system/app/AudioFX
rm -rf /system/priv-app/MusicFX
rm -rf /system/app/MusicFX
rm -rf /system/priv-app/DSPManager
rm -rf /system/app/DSPManager
rm -rf /data/data/com.vipercn.viper4android_2
rm -f /system/priv-app/ViPER4Android.apk
rm -f /system/app/ViPER4Android.apk
rm -f /system/priv-app/ViPER4Android_FX_A4.x.apk
rm -f /system/app/ViPER4Android_FX_A4.x.apk
rm -f /system/lib/soundfx/libv4a_fx_ics.so
rm -f /system/lib/libv4a_fx_ics.so
rm -r /system/su.d/arisesound_setprop

# Unzip the biohazard files into /tmp
mkdir $BIOHAZARD
cd $BIOHAZARD
unzip -o "$ZIP"

# Patch audio_effects.conf in various locations
if [ -f "/system/etc/audio_effects.conf" ]; then
  sed -i '/v4a_fx {/,/}/d' /system/etc/audio_effects.conf
  sed -i '/v4a_standard_fx {/,/}/d' /system/etc/audio_effects.conf
  sed -i 's/^libraries {/libraries {\n  v4a_fx {\n    path \/system\/lib\/soundfx\/libv4a_fx_ics.so\n  }/g' /system/etc/audio_effects.conf
  sed -i 's/^effects {/effects {\n  v4a_standard_fx {\n    library v4a_fx\n    uuid 41d3c987-e6cf-11e3-a88a-11aba5d5c51b\n  }/g' /system/etc/audio_effects.conf
fi
if [ -f "/system/vendor/etc/audio_effects.conf" ]; then
  sed -i '/v4a_fx {/,/}/d' /system/vendor/etc/audio_effects.conf
  sed -i '/v4a_standard_fx {/,/}/d' /system/vendor/etc/audio_effects.conf
  sed -i 's/^libraries {/libraries {\n  v4a_fx {\n    path \/system\/lib\/soundfx\/libv4a_fx_ics.so\n  }/g' /system/vendor/etc/audio_effects.conf
  sed -i 's/^effects {/effects {\n  v4a_standard_fx {\n    library v4a_fx\n    uuid 41d3c987-e6cf-11e3-a88a-11aba5d5c51b\n  }/g' /system/vendor/etc/audio_effects.conf
fi
if [ -f "/vendor/etc/audio_effects.conf" ]; then
  sed -i '/v4a_fx {/,/}/d' /vendor/etc/audio_effects.conf
  sed -i '/v4a_standard_fx {/,/}/d' /vendor/etc/audio_effects.conf
  sed -i 's/^libraries {/libraries {\n  v4a_fx {\n    path \/system\/lib\/soundfx\/libv4a_fx_ics.so\n  }/g' /vendor/etc/audio_effects.conf
  sed -i 's/^effects {/effects {\n  v4a_standard_fx {\n    library v4a_fx\n    uuid 41d3c987-e6cf-11e3-a88a-11aba5d5c51b\n  }/g' /vendor/etc/audio_effects.conf
fi
if [ -f "/system/etc/htc_audio_effects.conf" ]; then
  sed -i '/v4a_fx {/,/}/d' /system/etc/htc_audio_effects.conf
  sed -i '/v4a_standard_fx {/,/}/d' /system/etc/htc_audio_effects.conf
  sed -i 's/^libraries {/libraries {\n  v4a_fx {\n    path \/system\/lib\/soundfx\/libv4a_fx_ics.so\n  }/g' /system/etc/htc_audio_effects.conf
  sed -i 's/^effects {/effects {\n  v4a_standard_fx {\n    library v4a_fx\n    uuid 41d3c987-e6cf-11e3-a88a-11aba5d5c51b\n  }/g' /system/etc/htc_audio_effects.conf
fi
if [ -f "/system/etc/audio_effects_vendor.conf" ]; then
  sed -i '/v4a_fx {/,/}/d' /system/etc/audio_effects_vendor.conf
  sed -i '/v4a_standard_fx {/,/}/d' /system/etc/audio_effects_vendor.conf
  sed -i 's/^libraries {/libraries {\n  v4a_fx {\n    path \/system\/lib\/soundfx\/libv4a_fx_ics.so\n  }/g' /system/etc/audio_effects_vendor.conf
  sed -i 's/^effects {/effects {\n  v4a_standard_fx {\n    library v4a_fx\n    uuid 41d3c987-e6cf-11e3-a88a-11aba5d5c51b\n  }/g' /system/etc/audio_effects_vendor.conf
fi
if [ -f "/system/vendor/etc/audio_offload_effects.conf" ]; then
  sed -i '/v4a_fx {/,/}/d' /system/vendor/etc/audio_offload_effects.conf
  sed -i '/v4a_standard_fx {/,/}/d' /system/vendor/etc/audio_offload_effects.conf
  sed -i 's/^libraries {/libraries {\n  v4a_fx {\n    path \/system\/lib\/soundfx\/libv4a_fx_ics.so\n  }/g' /system/vendor/etc/audio_offload_effects.conf
  sed -i 's/^effects {/effects {\n  v4a_standard_fx {\n    library v4a_fx\n    uuid 41d3c987-e6cf-11e3-a88a-11aba5d5c51b\n  }/g' /system/vendor/etc/audio_offload_effects.conf
fi

# Place the files a/c to android versions
if [ "$API" -ge "21" ]; then
  mkdir -p /system/su.d
  cp -rf system/* /system
  cp biohazard/su.d/soundserver /system/su.d/soundserver
  if [ "$X86" ] || [ "$X8664" ]; then
    mkdir -p /system/priv-app/ViPER4Android/lib/x86
    cp biohazard/app/ViPER4Android.apk /system/priv-app/ViPER4Android/ViPER4Android.apk
    cp biohazard/app/lib/x86/libV4AJniUtils.so /system/priv-app/ViPER4Android/lib/x86/libV4AJniUtils.so
    cp biohazard/app/lib/x86/libV4AJniUtils.so /system/lib/libV4AJniUtils.so
    cp biohazard/lib/soundfx/libv4a_fx_jb_X86.so /system/lib/soundfx/libv4a_fx_ics.so
  else
    mkdir -p /system/priv-app/ViPER4Android/lib/arm
    cp biohazard/app/ViPER4Android.apk /system/priv-app/ViPER4Android/ViPER4Android.apk
    cp biohazard/app/lib/armeabi/libV4AJniUtils.so /system/priv-app/ViPER4Android/lib/arm/libV4AJniUtils.so
    cp biohazard/app/lib/armeabi/libV4AJniUtils.so /system/lib/libV4AJniUtils.so
    cp biohazard/lib/soundfx/libv4a_fx_jb_NEON.so /system/lib/soundfx/libv4a_fx_ics.so
  fi
  if [ -e "$LIB64" ]; then
    mkdir -p /system/lib64/soundfx
    cp biohazard/lib64/soundfx/libeffectproxy.so /system/lib64/soundfx/libeffectproxy.so
    chmod 0755 /system/lib64/soundfx
    chmod 0644 /system/lib64/soundfx/libeffectproxy.so
  fi
  set_perm_recursive 0 0 0700 0700 /system/su.d
  set_perm_recursive 0 0 0755 0644 /system/priv-app/ViPER4Android
  restorecon /system/su.d/soundserver
else
  cp -rf system/* /system
  cp biohazard/app/ViPER4Android.apk /system/app/ViPER4Android.apk
  chmod 0644 /system/app/ViPER4Android.apk
  if [ "$X86" ] || [ "$X8664" ]; then
    cp biohazard/app/lib/x86/libV4AJniUtils.so /system/lib/libV4AJniUtils.so
    cp biohazard/lib/soundfx/libv4a_fx_jb_X86.so /system/lib/soundfx/libv4a_fx_ics.so
  else
    cp biohazard/app/lib/armeabi/libV4AJniUtils.so /system/lib/libV4AJniUtils.so
    cp biohazard/lib/soundfx/libv4a_fx_jb_NEON.so /system/lib/soundfx/libv4a_fx_ics.so
  fi
fi

# Place common files to /system
cp biohazard/lib/soundfx/libeffectproxy.so /system/lib/soundfx/libeffectproxy.so
chmod 0644 /system/lib/libV4AJniUtils.so
chmod 0644 /system/lib/soundfx/libv4a_fx_ics.so
chmod 0644 /system/lib/soundfx/libeffectproxy.so

# Cleaning up the mod zip files
rm -rf $BIOHAZARD

# Unmount /system, /data and /vendor as r/w
umount /data
umount /system
if [ "$ANGL" ] || [ "$BULL" ] || [ "$FLOU" ]; then
  umount /vendor
fi

# Done, Enjoy the experience!
sleep 2
exit 0
